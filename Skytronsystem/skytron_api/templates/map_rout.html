<!DOCTYPE html>
<html lang="en">

<head>
    <title>Route Editing Map</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://skytrack.tech:2000/static/ol/ol.css">
    <style>
        #map {
            height: 500px;
            width: 100%;
        }

        .button-container {
            padding: 10px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://skytrack.tech:2000/static/ol/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
</head>

<body>
    <div class="button-container">
        <button onclick="submitRoute()">Submit Route</button>
        <button onclick="loadRoute()">Load Route</button>
    </div>

    <div id="map"></div>
    <script>
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([91.829437, 26.131644]),
                zoom: 7
            })
        });

        var vectorSource = new ol.source.Vector();
        var vectorLayer = new ol.layer.Vector({
            source: vectorSource
        });
        map.addLayer(vectorLayer);

        var points = [];
        var modify = new ol.interaction.Modify({ source: vectorSource });
        map.addInteraction(modify);

        function addPoint(coord) {
            var point = new ol.Feature({
                geometry: new ol.geom.Point(coord)
            });
            point.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    src: 'https://skytrack.tech:2000/static/track.png',
                    scale: 0.1
                })
            }));
            vectorSource.addFeature(point);
            points.push(point);
            updateRoute();
        }

        function updateRoute() {
            vectorSource.clear();
            vectorSource.addFeatures(points);
            if (points.length > 1) {
                var coordinates = points.map(p => p.getGeometry().getCoordinates());
                var line = new ol.geom.LineString(coordinates);
                var route = new ol.Feature({
                    geometry: line
                });
                vectorSource.addFeature(route);
            }
        }

        function updateRoute2(points) {
            //vectorSource.clear();
            //vectorSource.addFeatures(points);
            if (points.length > 1) {
                var coordinates = points.map(p => p.getGeometry().getCoordinates());
                var line = new ol.geom.LineString(coordinates);
                var route = new ol.Feature({
                    geometry: line
                });
                vectorSource.addFeature(route);
            }
        }

        map.on('click', function (e) {
            addPoint(e.coordinate);
        });

        map.on('contextmenu', function (e) {
            e.preventDefault(); // Prevent the browser context menu from opening
            map.forEachFeatureAtPixel(e.pixel, function (feature) {
                const index = points.findIndex(p => p === feature);
                if (index > -1) {
                    points.splice(index, 1); // Remove the point from the array
                    vectorSource.removeFeature(feature);
                    updateRoute();
                }
            });
        });

        function submitRoute() {
            var rdata = points.map(p => ol.proj.toLonLat(p.getGeometry().getCoordinates()));
            //  $.post('https://skytrack.tech:2000/api/saveRout/', { route: JSON.stringify(data) }, function (response) {
            //       console.log('Response from server:', response);
            //   });

            var data = {
                device_id: 1,  // Example device ID
                createdby_id: 1,  // Example created by user ID
                rout: rdata // Example route data
            };

            $.ajax({
                url: 'https://skytrack.tech:2000/api/saveRout/',
                type: 'POST',
                contentType: 'application/json',  // Setting the content type to application/json
                data: JSON.stringify(data),  // Converting the JavaScript object to a JSON string
                success: function (response) {
                    console.log('Response from server:', response);
                },
                error: function (xhr, status, error) {
                    console.log('Error:', error);
                }
            });
        }

        function loadRoute() {
            $.get('https://skytrack.tech:2000/api/getRout/', function (data) {
                vectorSource.clear();  // Assuming vectorSource is already defined
                console.log('rout', data);
                console.log('rout', data.rout);
                let points = JSON.parse(data.rout);  // Parse if the route data is not already an array
                var pts = [];
                points.forEach(coords => {
                    console.log('coords', coords);
                    var point = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat(coords))
                    });
                    point.setStyle(new ol.style.Style({
                        image: new ol.style.Icon({
                            src: 'https://skytrack.tech:2000/static/track.png',
                            scale: 0.1
                        })
                    }));
                    pts.push(point);
                    vectorSource.addFeature(point);
                });
                updateRoute2(pts);
            }).fail(function (error) {
                console.log('Error fetching route:', error);
            });
        }
    </script>
</body>

</html>